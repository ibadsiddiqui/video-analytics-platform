// Prisma Schema for Video Analytics Platform
// Database: PostgreSQL (Vercel Postgres / Neon / Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Stores analyzed video data
model Video {
  id              String   @id @default(cuid())
  platform        Platform
  platformVideoId String   @unique
  url             String
  title           String?
  description     String?
  thumbnailUrl    String?
  channelName     String?
  channelId       String?
  publishedAt     DateTime?
  duration        Int?     // Duration in seconds
  
  // Engagement metrics
  viewCount       BigInt   @default(0)
  likeCount       BigInt   @default(0)
  commentCount    BigInt   @default(0)
  shareCount      BigInt   @default(0)
  
  // Calculated metrics
  engagementRate  Float?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastFetchedAt   DateTime @default(now())
  
  // Relations
  analytics       Analytics[]
  comments        Comment[]
  
  @@index([platform, platformVideoId])
  @@index([createdAt])
}

// Stores time-series analytics snapshots
model Analytics {
  id              String   @id @default(cuid())
  videoId         String
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  // Snapshot metrics
  viewCount       BigInt   @default(0)
  likeCount       BigInt   @default(0)
  commentCount    BigInt   @default(0)
  
  // Engagement by day of week (JSON: {mon: 0, tue: 0, ...})
  engagementByDay Json?
  
  // Sentiment analysis results
  sentimentScore  Float?   // -1 to 1
  positivePercent Float?
  neutralPercent  Float?
  negativePercent Float?
  
  // Audience demographics (JSON)
  demographics    Json?
  
  // Top keywords and hashtags (JSON array)
  topKeywords     Json?
  topHashtags     Json?
  
  // Timestamp
  recordedAt      DateTime @default(now())
  
  @@index([videoId, recordedAt])
}

// Stores comments for sentiment analysis
model Comment {
  id              String   @id @default(cuid())
  videoId         String
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  platformCommentId String?
  authorName      String?
  content         String
  likeCount       Int      @default(0)
  publishedAt     DateTime?
  
  // Sentiment analysis
  sentiment       Sentiment @default(NEUTRAL)
  sentimentScore  Float?
  
  createdAt       DateTime @default(now())
  
  @@index([videoId])
  @@index([sentiment])
}

// API request logging for rate limiting and analytics
model ApiRequest {
  id              String   @id @default(cuid())
  ipAddress       String?
  userAgent       String?
  endpoint        String
  videoUrl        String?
  responseTime    Int?     // milliseconds
  statusCode      Int?
  
  createdAt       DateTime @default(now())
  
  @@index([ipAddress, createdAt])
  @@index([createdAt])
}

enum Platform {
  YOUTUBE
  INSTAGRAM
  TIKTOK
  VIMEO
  OTHER
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}
