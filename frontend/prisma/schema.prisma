// Prisma Schema for Video Analytics Platform
// Database: PostgreSQL (Vercel Postgres / Neon / Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Stores analyzed video data
model Video {
  id              String   @id @default(cuid())
  platform        Platform
  platformVideoId String   @unique
  url             String
  title           String?
  description     String?
  thumbnailUrl    String?
  channelName     String?
  channelId       String?
  publishedAt     DateTime?
  duration        Int?     // Duration in seconds
  
  // Engagement metrics
  viewCount       BigInt   @default(0)
  likeCount       BigInt   @default(0)
  commentCount    BigInt   @default(0)
  shareCount      BigInt   @default(0)
  
  // Calculated metrics
  engagementRate  Float?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastFetchedAt   DateTime @default(now())
  
  // Relations
  analytics       Analytics[]
  comments        Comment[]
  
  @@index([platform, platformVideoId])
  @@index([createdAt])
}

// Stores time-series analytics snapshots
model Analytics {
  id              String   @id @default(cuid())
  videoId         String
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  // Snapshot metrics
  viewCount       BigInt   @default(0)
  likeCount       BigInt   @default(0)
  commentCount    BigInt   @default(0)
  
  // Engagement by day of week (JSON: {mon: 0, tue: 0, ...})
  engagementByDay Json?
  
  // Sentiment analysis results
  sentimentScore  Float?   // -1 to 1
  positivePercent Float?
  neutralPercent  Float?
  negativePercent Float?
  
  // Audience demographics (JSON)
  demographics    Json?
  
  // Top keywords and hashtags (JSON array)
  topKeywords     Json?
  topHashtags     Json?
  
  // Timestamp
  recordedAt      DateTime @default(now())
  
  @@index([videoId, recordedAt])
}

// Stores comments for sentiment analysis
model Comment {
  id              String   @id @default(cuid())
  videoId         String
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  platformCommentId String?
  authorName      String?
  content         String
  likeCount       Int      @default(0)
  publishedAt     DateTime?
  
  // Sentiment analysis
  sentiment       Sentiment @default(NEUTRAL)
  sentimentScore  Float?
  
  createdAt       DateTime @default(now())
  
  @@index([videoId])
  @@index([sentiment])
}

// API request logging for rate limiting and analytics
model ApiRequest {
  id              String   @id @default(cuid())
  ipAddress       String?
  userAgent       String?
  endpoint        String
  videoUrl        String?
  responseTime    Int?     // milliseconds
  statusCode      Int?
  
  createdAt       DateTime @default(now())
  
  @@index([ipAddress, createdAt])
  @@index([createdAt])
}

enum Platform {
  YOUTUBE
  INSTAGRAM
  VIMEO
  OTHER
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

// ============================================
// Phase 1.1: Clerk Authentication System
// ============================================

// User model with Clerk integration
model User {
  id              String    @id @default(cuid())
  clerkId         String    @unique
  email           String    @unique
  firstName       String?
  lastName        String?
  imageUrl        String?

  // Subscription tier
  tier            UserTier  @default(FREE)

  // Usage tracking
  dailyRequests   Int       @default(0)
  lastRequestDate DateTime?

  // Relations - placeholders for future phases
  apiKeys         UserApiKey[]
  competitors     CompetitorTrack[]    // Phase 2.1
  superfans       Superfan[]           // Phase 5.2
  // analyses        VideoAnalysis[]      // Phase 2+
  // campaigns       Campaign[]           // Phase 9
  // alerts          Alert[]              // Phase 7
  // reports         Report[]             // Phase 11

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([clerkId])
  @@index([email])
}

// User subscription tiers
enum UserTier {
  FREE      // 5 requests/day
  CREATOR   // 100 requests/day
  PRO       // 500 requests/day
  AGENCY    // 2000 requests/day
}

// User API keys for programmatic access (Phase 1.2)
model UserApiKey {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  platform        String    // 'YOUTUBE' | 'INSTAGRAM'
  encryptedKey    String    // AES-256-GCM encrypted
  iv              String    // Initialization vector
  authTag         String    // Authentication tag
  salt            String    // Random salt for key derivation
  label           String?   // User-friendly label
  isActive        Boolean   @default(true)
  lastUsedAt      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([platform])
}

// ============================================
// Phase 2.1: Competitor Tracking & Benchmarks
// ============================================

enum VideoNiche {
  GAMING
  TECH
  BEAUTY
  VLOGS
  EDUCATION
  MUSIC
  SPORTS
  ENTERTAINMENT
  COOKING
  TRAVEL
  BUSINESS
  HEALTH
  OTHER
}

// Tracks competitor channels for a user (Phase 2.1)
model CompetitorTrack {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  platform        Platform
  channelId       String
  channelName     String
  channelUrl      String
  thumbnailUrl    String?
  niche           VideoNiche

  // Latest metrics (updated periodically)
  subscriberCount BigInt    @default(0)
  videoCount      Int       @default(0)
  totalViews      BigInt    @default(0)
  avgEngagement   Float?

  // Status and tracking
  isActive        Boolean   @default(true)
  firstTrackedAt  DateTime  @default(now())
  lastCheckedAt   DateTime?
  lastFetchedAt   DateTime  @default(now())

  // Relations
  snapshots       CompetitorSnapshot[]

  @@unique([userId, platform, channelId])
  @@index([userId])
  @@index([userId, isActive])
}

// Daily snapshots of competitor metrics (Phase 2.1)
model CompetitorSnapshot {
  id              String    @id @default(cuid())
  competitorId    String
  competitor      CompetitorTrack @relation(fields: [competitorId], references: [id], onDelete: Cascade)

  // Snapshot metrics
  subscriberCount BigInt
  videoCount      Int
  totalViews      BigInt
  recentVideos    Json?     // Last 5 video performance data
  avgEngagement   Float?

  // Recording
  recordedAt      DateTime  @default(now())

  @@index([competitorId, recordedAt])
  @@index([recordedAt])
}

// Aggregate benchmark metrics by niche (Phase 2.1)
model Benchmark {
  id              String    @id @default(cuid())
  platform        Platform
  niche           VideoNiche

  // Aggregate metrics (calculated from snapshots)
  avgViewCount    BigInt    @default(0)
  avgLikeCount    BigInt    @default(0)
  avgCommentCount BigInt    @default(0)
  avgEngagementRate Float   @default(0)

  // Percentile data (JSON: {p10: 100, p25: 500, p50: 1000, p75: 5000, p90: 10000})
  viewPercentiles Json?
  engagementPercentiles Json?

  // Sample size
  sampleSize      Int       @default(0)

  // Last updated
  updatedAt       DateTime  @updatedAt

  @@unique([platform, niche])
  @@index([platform])
}

// ============================================
// Phase 5.2: Superfan Identification
// ============================================

// Tracks highly engaged community members
model Superfan {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  platform        Platform
  channelId       String    // Channel this superfan engages with
  fanUsername     String    // The superfan's username
  fanProfileUrl   String?   // Link to their profile

  // Engagement metrics
  totalComments   Int       @default(0)
  totalLikes      Int       @default(0)  // Likes received on their comments
  firstSeenAt     DateTime
  lastSeenAt      DateTime

  // Sentiment
  avgSentiment    Float?    // -1 to 1

  // Calculated engagement score (0-100)
  engagementScore Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, platform, channelId, fanUsername])
  @@index([userId, channelId])
  @@index([channelId])
}
